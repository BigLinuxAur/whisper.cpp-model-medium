_baseurl='https://github.com/ggerganov/whisper.cpp'
_model='medium'
_pkgbase='whisper.cpp-model'
_download_script_url='https://github.com/ggerganov/whisper.cpp/raw/master/models/download-ggml-model.sh'
_download_script_sha256sum='5c7e3fa19b688cb5ef5c08484d7a28d951f5afa1f4642232953e7ccd4435126f'
_download_script_basename='download-ggml-model.sh'
# Maintainer: Hauke Rehfeld <aur@haukerehfeld.de>
pkgname="${_pkgbase}-${_model}"

pkgver() {
  git ls-remote "$_baseurl" master | cut -f 1 | sed 's/\([^-]*-g\)/r\1/;s/-/./g'
}


pkgver=2
pkgrel=1
pkgdesc="This is an autogenerated file, please see https://github.com/hrehfeld/archlinux-whisper.cpp-model"
arch=("i686" "x86_64")
url="${_baseurl}/tree/master/models"
license=("MIT")

makedepends=()
depends=()
conflicts=()
provides=()

_model_file="ggml-${_model}.bin"
_model_path="/usr/share/$pkgname/${_model_file}"

_versioned_download_script_basename="${_download_script_basename%.*}-$(pkgver).${_download_script_basename##*.}"

source=("$_versioned_download_script_basename::$_download_script_url")
sha256sums=("$_download_script_sha256sum")

prepare() {
    chmod +x $_versioned_download_script_basename
    ./$_versioned_download_script_basename "$_model" "."
}


package() {
  install -Dm644 "${srcdir}/${_model_file}" "$pkgdir$_model_path"

  wrapper="whisper.cpp-${_model}"
  echo "#!/bin/sh
/usr/bin/whisper.cpp --model ${_model_path} "\"'$@'\" > "$srcdir/$wrapper"
  install -Dm755 "${srcdir}/$wrapper" "$pkgdir/usr/bin/$wrapper"


}
